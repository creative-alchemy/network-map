<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet' />
    <link href="./styles.css" rel="stylesheet" />
    <!-- CSS only -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <!-- JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
    </style>
    <script>
      var checkedFilters = {};

      var updateFilters = function(element) {
        if (element.type === 'checkbox') {
          checkedFilters[element.name] = element.checked;
        }

        console.log({ checkedFilters });
      }

    </script>
  </head>
  <body>
    <div id="map" style="width: 100%; height: 100vh;"></div>
    <div id="filter-results-by">
      <div id="filter-results-by__title">Filter results by</div>
      <form id="filter-form">
        <div>
          <input id="prepared-to-teach-learning-network" name="Prepared To Teach Learning Network" type="checkbox" value="Prepared To Teach Learning Network" checked>
          <label for="prepared-to-teach-learning-network">Prepared To Teach Learning Network</label>
        </div>
        <div>
          <input id="urban" onchange="updateFilters(this)" name="Urban" type="checkbox" value="Urban" checked>
          <label for="urban">Urban</label>
        </div>
        <div>
          <input id="suburban" onchange="updateFilters(this)" name="Suburban" type="checkbox" value="suburban" checked>
          <label for="suburban">Suburban</label>
        </div>
        <div>
          <input id="rural" onchange="updateFilters(this)" name="Rural" type="checkbox" value="Rural" checked>
          <label for="rural">Rural</label>
        </div>
        <div>
          <div>
            <input id="state-all" onchange="updateFilters(this)" name="state:all" type="checkbox" value="state:all" checked>
            <label for="state-all">
              <a class="collapse-toggle" data-toggle="collapse" href="#state__collapse" aria-expanded="false" aria-controls="state">States</a>
              <svg width="0.8em" height="0.8em" viewBox="0 0 16 16" class="bi bi-caret-down-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
              </svg>
            </label>
          </div>
          <div class="row">
            <div class="col">
              <div class="collapse multi-collapse sub-contents" id="state__collapse"></div>
            </div>
          </div>
        </div>
        <div>
          <div>
            <input id="preparation-programs-all" onchange="updateFilters(this)" name="preparation-programs:all" type="checkbox" value="preparation-programs:all" checked>
            <label for="preparation-programs-all">
              <a class="collapse-toggle" data-toggle="collapse" href="#preparation-programs__collapse" aria-expanded="false" aria-controls="preparation-programs__collapse">Preparation Programs</a>
              <svg width="0.8em" height="0.8em" viewBox="0 0 16 16" class="bi bi-caret-down-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
              </svg>
            </label>
          </div>
          <div class="row">
            <div class="col">
              <div class="collapse multi-collapse sub-contents" id="preparation-programs__collapse"></div>
            </div>
          </div>
        </div>
        <div>
          <div>
            <input id="schools-all" onchange="updateFilters(this)" name="schools:all" type="checkbox" value="schools:all" checked>
            <label for="schools-all">
              <a class="collapse-toggle" data-toggle="collapse" href="#schools__collapse" aria-expanded="false" aria-controls="schools__collapse">Schools</a>
              <svg width="0.8em" height="0.8em" viewBox="0 0 16 16" class="bi bi-caret-down-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
              </svg>
            </label>
          </div>
          <div class="row">
            <div class="col">
              <div class="collapse multi-collapse sub-contents" id="schools__collapse"></div>
            </div>
          </div>
        </div>
      </form>
    </div>
    <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiY3JlYXRpdmVhbGNoZW15IiwiYSI6ImNrY3hncmZsaDAzd2Uycm1kMDMzendla2oifQ.Ipc4OYyTLjhevQR9_Y8TBA';
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/creativealchemy/ckcxibvcp0wb01iml0xpco9o2',
      center: [-100.5795, 39.8283], // center of U.S.
      zoom: 4 // starting zoom
    });

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    map.on('load', function() {
      // Find all features in one source layer in a vector source
      var schoolFeatures = map.querySourceFeatures('composite', {
        'sourceLayer': "school_data_08_06_20"
      });

      var universityFeatures = map.querySourceFeatures('composite', {
        'sourceLayer': "university_data_08_06_20"
      });

      var reformattedUniversityFeatures = universityFeatures.map(function(university) {
        var universityFeature = university.properties;
        var licensureAreas = [];

        for (var key in universityFeature) {
          if (key.includes('Licensure Area') && universityFeature[key]) {
            licensureAreas.push(universityFeature[key]);
          }
        }

        universityFeature.licensureAreas = licensureAreas;
        return university;
      });

      window.showOnlyCharterSchools = function() {
        map.setFilter('school-data-08-06-20', ['==', ['get', 'Charter School'], 'Yes']);
        map.setFilter('university-data-08-06-20', ['==', ['get', 'Charter School'], 'Yes']);
      }

      window.showOnlyElementaryCharterSchools = function() {
        var filterOptions = ['all',
          ['==', ['get', 'Charter School'], 'Yes'],
          ['==', ['get', 'Grade Level'], 'Elementary']
        ];

        map.setFilter('school-data-08-06-20', filterOptions);
        map.setFilter('university-data-08-06-20', filterOptions);
      }

      window.showOnlyMusicAndPhysicalEducationIHEs = function() {
        // Filter array of universities
        var filteredUniversities = reformattedUniversityFeatures.filter(function(universityFeature) {
          var licensureAreas = universityFeature.properties.licensureAreas;
          // If the licensureAreas array includes 'Music' and 'Physical Education'
          if (licensureAreas.includes('Music') && licensureAreas.includes('Visual Arts')) {
            // return the university object
            return universityFeature;
          }
        });

        // Grab the university names and save it as universitiesArray
        var universityNames = filteredUniversities.map(function(university) {
          return university.properties['IHE Name '];
        });

        // Pass the universitiesArray into the filterOptions ['get', 'IHE Name ']
        // Render universities that has both music and physical education by passing in the universitiesArray 
        var filterOptions = ['all'];

        universityNames.forEach(function(name) {
          filterOptions.push(['==', ['get', 'IHE Name '], name]);
        });

        map.setFilter('school-data-08-06-20', filterOptions);
        map.setFilter('university-data-08-06-20', filterOptions);
      }

      var isItPTT = function(PTTNetwork) {
        // console.log('PTTNetwork', PTTNetwork);
      }

      var isItCharterSchool = function(charterSchool) {
        // console.log('charterSchool', charterSchool);

        if (charterSchool === 'Yes') {
          return true;
        } else {
          return false;
        }
      }

      var features = schoolFeatures.concat(universityFeatures);

      features.forEach(function(feature) {
        isItPTT(feature.properties['PTT Network']);
        if (isItCharterSchool(feature.properties['Charter School'])) {
          console.log('feature:', feature);
        }
      });

      console.log('features:', features);

      // var bounds = new mapboxgl.LngLatBounds();
      // features.forEach(function(feature) {
      //   bounds.extend(feature.geometry.coordinates);
      // });
      // map.fitBounds(bounds, { padding: 100 });

      var handleClick = function(e) {
        var features = map.queryRenderedFeatures(e.point);

        var coordinates = features[0].geometry.coordinates.slice();
        var description = JSON.stringify(features[0].properties);
        
        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        new mapboxgl.Popup()
          .setLngLat(coordinates)
          .setHTML(description)
          .addTo(map);
      }

      var setCursorPointer = function() { map.getCanvas().style.cursor = 'pointer'; };
      var setCursorDefault = function() { map.getCanvas().style.cursor = 'pointer'; };

      // When a click event occurs on a feature in the school_data layer, open a popup at the
      // location of the feature, with description HTML from its properties.
      map.on('click', 'school-data-08-06-20', handleClick);
      map.on('click', 'university-data-08-06-20', handleClick);

      map.on('mousemove', 'school-data-08-06-20', setCursorPointer);
      map.on("mouseleave", 'school-data-08-06-20', setCursorDefault);
      map.on('mousemove', 'university-data-08-06-20', setCursorPointer);
      map.on("mouseleave", 'university-data-08-06-20', setCursorDefault);
    });
    
    </script>
    <script src="./populate-filters.js"></script>
  </body>
</html>