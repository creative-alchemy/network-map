<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.11.1/mapbox-gl.css' rel='stylesheet' />
    <link href="./styles.css" rel="stylesheet" />
    <!-- CSS only -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <!-- JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <style>
      body {
        margin: 0px;
        padding: 0px;
      }
    </style>
    <script>
      var filters = {};
      var activeLicensureAreas = {};

      var updateFilters = function(element) {
        // update application state
        if (element.type === 'checkbox') {
          filters[element.name] = element.checked;
          if (element.name.includes('licensure-areas') && element.checked === true) {
            activeLicensureAreas[element.value] = element.checked;
          } else if (element.name.includes('licensure-areas') && element.checked === false) {
            delete activeLicensureAreas[element.value];
          }
        }

        // Filters by disqualification
        var filteredFeatures = features.filter(function(feature) {
          // If none of the locales match, return false
          if (
            filters["global:locale:urban"] ||
            filters["global:locale:suburban"] ||
            filters["global:locale:rural"] ||
            filters["global:locale:city"] ||
            filters["global:locale:town"]
          ) {
            var foundALocaleMatch = false;
            if (
              filters["global:locale:urban"] && feature.properties["Locale"] === "Urban" ||
              filters["global:locale:suburban"] && feature.properties["Locale"].includes("Suburb") ||
              filters["global:locale:rural"] && feature.properties["Locale"] === "Rural" ||
              filters["global:locale:city"] && feature.properties["Locale"] === "City" ||
              filters["global:locale:town"] && feature.properties["Locale"] === "Town"
            ) {
              foundALocaleMatch = true;
            }

            if (foundALocaleMatch === false) {
              return false;
            }
          }

          
          if (feature.properties["IHE Name "]) {
            // For IHEs, check type
            if (
              filters["preparation-programs:type:public"] ||
              filters["preparation-programs:type:private"]
            ) {
              var foundAnIHETypeMatch = false;
              if (
                filters["preparation-programs:type:public"] && feature.properties["Type"] === "Public" ||
                filters["preparation-programs:type:private"] && feature.properties["Type"] === "Private"
              ) {
                foundAnIHETypeMatch = true;
              }
  
              if (foundAnIHETypeMatch === false) {
                return false;
              }
            }
  
            // For IHEs, check size
            if (
              filters["preparation-programs:size:large"] ||
              filters["preparation-programs:size:medium"] ||
              filters["preparation-programs:size:small"]
            ) {
              var foundAnIHESizeMatch = false;
              if (
                filters["preparation-programs:size:large"] && feature.properties["Size"] === "Large" ||
                filters["preparation-programs:size:medium"] && feature.properties["Size"] === "Mid" ||
                filters["preparation-programs:size:small"] && feature.properties["Size"] === "Small"
              ) {
                foundAnIHESizeMatch = true;
              }
  
              if (foundAnIHESizeMatch === false) {
                return false;
              }
            }
          }

          if (feature.properties["School Name"]) {
            // For schools, check type
            if (
              filters["schools:type:public"] ||
              filters["schools:type:private"] ||
              filters["schools:type:charter"]
            ) {
              var foundASchoolTypeMatch = false;
              if (
                filters["schools:type:public"] && feature.properties["Type"] === "Public" ||
                filters["schools:type:private"] && feature.properties["Type"] === "Private" ||
                filters["schools:type:charter"] && feature.properties["Type"] === "Charter"
              ) {
                foundASchoolTypeMatch = true;
              }
  
              if (foundASchoolTypeMatch === false) {
                return false;
              }
            }

            // For schools, check size
            if (
              filters["schools:size:large"] ||
              filters["schools:size:medium"] ||
              filters["schools:size:small"]
            ) {
              var foundASchoolSizeMatch = false;
              if (
                filters["schools:size:large"] && feature.properties["Type/Size"] === "Large" ||
                filters["schools:size:medium"] && feature.properties["Type/Size"] === "Mid" ||
                filters["schools:size:small"] && feature.properties["Type/Size"] === "Small"
              ) {
                foundASchoolSizeMatch = true;
              }
  
              if (foundASchoolSizeMatch === false) {
                return false;
              }
            }

            // For schools, check grade-level
            if (
              filters["schools:grade-level:elementary"] ||
              filters["schools:grade-level:middle"] ||
              filters["schools:grade-level:high"]
            ) {
              var foundAGradeLevelMatch = false;
              if (
                filters["schools:grade-level:elementary"] && feature.properties["Grade Level"] === "Elementary" ||
                filters["schools:grade-level:middle"] && feature.properties["Grade Level"] === "Middle" ||
                filters["schools:grade-level:high"] && feature.properties["Grade Level"] === "High" ||
                feature.properties["Grade Level"] === "Other"
              ) {
                foundAGradeLevelMatch = true;
              }

              if (foundAGradeLevelMatch === false) {
                return false;
              }
            }


            // Check if school supports high-needs
            if (filters["schools:high-needs"]) {
              if (feature.properties["High-Needs School"] === "Yes") {
                return true;
              }
            }

            // For schools, check for what they host
            if (filters["schools:hosts-pre-clinical-hours"]) {
              if (feature.properties["Hosts Pre-Clinical Placement (Field-Placement)"] === "Yes") {
                return true;
              } else {
                return false;
              }
            }

            if (filters["schools:hosts-culminating-clinical-placements"]) {
              if (feature.properties["Hosts Culminating Clinical Placement"] =foundAnIHETypeMatch== "Yes") {
                return true;
              } else {
                return false;
              }
            }

            if (filters["schools:hosts-year-long-clinical-placements"]) {
              if (feature.properties["Hosts Culminating Year-Long Clinical Placement"] === "Yes") {
                return true;
              } else {
                return false;
              }
            }

            if (filters["schools:hosts-enrichment-programs"]) {
              if (feature.properties["Hosts Enrichment Program"] === "Yes") {
                return true;
              } else {
                return false;
              }
            }

            // For schools, check if it is or isn't a professional development school
            if (filters["schools:professional-development-school"]) {
              if (feature.properties["Professional Development School (PDS Model)"] === "Yes") {
                return true;
              } else {
                return false;
              }
            }
          }

          // Check licensure areas
          if (element.name.includes("licensure-areas")) {
            var currentLicensureAreas = Object.keys(activeLicensureAreas);
            if (currentLicensureAreas.length > 0) {
              var foundLicensureAreaMatch = false;
              currentLicensureAreas.forEach(function(licensureArea) {
                if (feature.properties["Licensure Areas"] && feature.properties["Licensure Areas"].includes(licensureArea)) {
                  foundLicensureAreaMatch = true;
                }
              });
              return foundLicensureAreaMatch;
            }
          }

          // Check ptt-network
          if (filters["global:ptt-network"]) {
            if (feature.properties["PTT Network"] === "Yes") {
              return true;
            } else {
              return false;
            }
          }

          return true;
        });

        var filterOptions = ['any'];
        filteredFeatures.forEach(function(filterFeature) {
          if (filterFeature.properties["IHE Name "]) {
            filterOptions.push(['==', ['get', 'IHE Name '], filterFeature.properties["IHE Name "]]);
          } else if (filterFeature.properties["School Name"]) {
            filterOptions.push(['==', ['get', 'School Name'], filterFeature.properties["School Name"]]);
          }
        })

        map.setFilter('school-data-08-06-20', filterOptions);
        map.setFilter('university-data-08-06-20', filterOptions);

        if (filteredFeatures.length > 1) {
          var bounds = new mapboxgl.LngLatBounds();
          filteredFeatures.forEach(function(feature) {
            bounds.extend(feature.geometry.coordinates);
          });
          map.fitBounds(bounds, { padding: 100, offset: [100, 0] });
        } else if (filteredFeatures.length === 1) {
            map.flyTo({
              center: filteredFeatures[0].geometry.coordinates,
              essential: true,
              zoom: 6,
            });
        }

        console.log('features length', filteredFeatures.length);
      }

    </script>
  </head>
  <body>
    <div id="map" style="width: 100%; height: 100vh;"></div>
    <div id="filter-results-by">
      <div id="filter-results-by__title"><b>Filter results by</b></div>
      <form id="filter-form">
        <div>
          <input id="prepared-to-teach-learning-network" onchange="updateFilters(this)" name="global:ptt-network" type="checkbox" value="Prepared To Teach Learning Network" autocomplete="off">
          <label for="prepared-to-teach-learning-network">Prepared To Teach Learning Network</label>
        </div>
        <div>
          <div>
            <input id="locales-all" onchange="updateFilters(this)" name="locales:all" type="checkbox" value="locales:all" autocomplete="off">
            <label for="locales-all">
              <a class="collapse-toggle" data-toggle="collapse" href="#locales__collapse" aria-expanded="false" aria-controls="locales__collapse">
                Locales
                <svg width="0.8em" height="0.8em" viewBox="0 0 16 16" class="bi bi-caret-down-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                </svg>
              </a>
            </label>
          </div>
          <div class="row">
            <div class="col">
              <div class="collapse multi-collapse sub-contents show" id="locales__collapse">
                <div>
                  <input id="urban" onchange="updateFilters(this)" name="global:locale:urban" type="checkbox" value="Urban" autocomplete="off">
                  <label for="urban">Urban</label>
                </div>
                <div>
                  <input id="suburban" onchange="updateFilters(this)" name="global:locale:suburban" type="checkbox" value="suburban" autocomplete="off">
                  <label for="suburban">Suburban</label>
                </div>
                <div>
                  <input id="rural" onchange="updateFilters(this)" name="global:locale:rural" type="checkbox" value="Rural" autocomplete="off">
                  <label for="rural">Rural</label>
                </div>
                <div>
                  <input id="city" onchange="updateFilters(this)" name="global:locale:city" type="checkbox" value="City" autocomplete="off">
                  <label for="city">City</label>
                </div>
                <div>
                  <input id="town" onchange="updateFilters(this)" name="global:locale:town" type="checkbox" value="Town" autocomplete="off">
                  <label for="town">Town</label>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- <div>
          <div>
            <input id="state-all" onchange="updateFilters(this)" name="state:all" type="checkbox" value="state:all" autocomplete="off">
            <label for="state-all">
              <a class="collapse-toggle" data-toggle="collapse" href="#state__collapse" aria-expanded="false" aria-controls="state">States</a>
              <svg width="0.8em" height="0.8em" viewBox="0 0 16 16" class="bi bi-caret-down-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
              </svg>
            </label>
          </div>
          <div class="row">
            <div class="col">
              <div class="collapse multi-collapse sub-contents" id="state__collapse"></div>
            </div>
          </div>
        </div> -->
        <div>
          <div>
            <input id="preparation-programs-all" onchange="updateFilters(this)" name="preparation-programs:all" type="checkbox" value="preparation-programs:all" autocomplete="off">
            <label for="preparation-programs-all">
              <a class="collapse-toggle" data-toggle="collapse" href="#preparation-programs__collapse" aria-expanded="false" aria-controls="preparation-programs__collapse">
                Preparation Programs
                <svg width="0.8em" height="0.8em" viewBox="0 0 16 16" class="bi bi-caret-down-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                </svg>
              </a>
            </label>
          </div>
          <div class="row">
            <div class="col">
              <div class="collapse multi-collapse sub-contents show" id="preparation-programs__collapse"></div>
            </div>
          </div>
        </div>
        <div>
          <div>
            <input id="schools-all" onchange="updateFilters(this)" name="schools:all" type="checkbox" value="schools:all" autocomplete="off">
            <label for="schools-all">
              <a class="collapse-toggle" data-toggle="collapse" href="#schools__collapse" aria-expanded="false" aria-controls="schools__collapse">
                Schools
                <svg width="0.8em" height="0.8em" viewBox="0 0 16 16" class="bi bi-caret-down-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/>
                </svg>
              </a>
            </label>
          </div>
          <div class="row">
            <div class="col">
              <div class="collapse multi-collapse sub-contents show" id="schools__collapse"></div>
            </div>
          </div>
        </div>
      </form>
    </div>
    <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiY3JlYXRpdmVhbGNoZW15IiwiYSI6ImNrY3hncmZsaDAzd2Uycm1kMDMzendla2oifQ.Ipc4OYyTLjhevQR9_Y8TBA';
    var map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/creativealchemy/ckcxibvcp0wb01iml0xpco9o2',
      center: [-100.5795, 39.8283], // center of U.S.
      zoom: 4 // starting zoom
    });

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    map.on('load', function() {
      // Find all features in one source layer in a vector source
      var schoolFeatures = map.querySourceFeatures('composite', {
        'sourceLayer': "school_data_08_06_20"
      });

      var universityFeatures = map.querySourceFeatures('composite', {
        'sourceLayer': "university_data_08_06_20"
      });

      var reformattedUniversityFeatures = universityFeatures.map(function(university) {
        var universityFeature = university.properties;
        var licensureAreas = [];

        for (var key in universityFeature) {
          if (key.includes('Licensure Area ') && universityFeature[key]) {
            licensureAreas.push(universityFeature[key]);
          }
        }

        universityFeature['Licensure Areas'] = licensureAreas;
        return university;
      });

      window.features = schoolFeatures.concat(universityFeatures);

      var handleClick = function(e) {
        var features = map.queryRenderedFeatures(e.point);

        var coordinates = features[0].geometry.coordinates.slice();
        var description = JSON.stringify(features[0].properties);
        
        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
          coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        new mapboxgl.Popup()
          .setLngLat(coordinates)
          .setHTML(description)
          .addTo(map);
      }

      var setCursorPointer = function() { map.getCanvas().style.cursor = 'pointer'; };
      var setCursorDefault = function() { map.getCanvas().style.cursor = 'pointer'; };

      // When a click event occurs on a feature in the school_data layer, open a popup at the
      // location of the feature, with description HTML from its properties.
      map.on('click', 'school-data-08-06-20', handleClick);
      map.on('click', 'university-data-08-06-20', handleClick);

      map.on('mousemove', 'school-data-08-06-20', setCursorPointer);
      map.on("mouseleave", 'school-data-08-06-20', setCursorDefault);
      map.on('mousemove', 'university-data-08-06-20', setCursorPointer);
      map.on("mouseleave", 'university-data-08-06-20', setCursorDefault);
    });
    
    </script>
    <script src="./populate-filters.js"></script>
  </body>
</html>